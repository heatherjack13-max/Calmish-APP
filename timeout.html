<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Out - Calmish</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Suisse+Int'l:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Canela:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --sage-green: #A8C09A;
            --dusty-rose: #D4A5A5;
            --warm-cream: #F7F3E9;
            --soft-lavender: #C8B5D1;
            --muted-coral: #E8B4A0;
            --pale-blue: #B8D4E3;
            --warm-gray: #E5E1DB;
            --golden-honey: #E6C068;
            --deep-sage: #7A9471;
        }
        
        body {
            font-family: 'Suisse Int\'l', sans-serif;
            background: linear-gradient(135deg, var(--warm-cream) 0%, var(--pale-blue) 50%, var(--soft-lavender) 100%);
            background-attachment: fixed;
            min-height: 100vh;
        }
        
        .font-display {
            font-family: 'Canela', serif;
        }
        
        .glass-card {
            background: rgba(247, 243, 233, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(168, 192, 154, 0.2);
        }
        
        .nav-bottom {
            background: rgba(247, 243, 233, 0.95);
            backdrop-filter: blur(15px);
            border-top: 1px solid rgba(168, 192, 154, 0.3);
        }
        
        .breathing-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--sage-green), var(--dusty-rose));
            box-shadow: 0 0 30px rgba(168, 192, 154, 0.3);
        }
        
        .breathing-circle.inhale {
            animation: inhale 4s ease-in-out infinite;
        }
        
        .breathing-circle.exhale {
            animation: exhale 4s ease-in-out infinite;
        }
        
        .breathing-circle.hold {
            animation: hold 4s ease-in-out infinite;
        }
        
        @keyframes inhale {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.3); }
        }
        
        @keyframes exhale {
            0%, 100% { transform: scale(1.3); }
            25% { transform: scale(1); }
        }
        
        @keyframes hold {
            0%, 50%, 100% { transform: scale(1); }
            25% { transform: scale(1.2); }
        }
        
        .sound-wave {
            width: 4px;
            background: var(--sage-green);
            border-radius: 2px;
            animation: soundWave 1.5s ease-in-out infinite;
        }
        
        @keyframes soundWave {
            0%, 100% { height: 10px; }
            50% { height: 30px; }
        }
        
        .nav-bottom {
            background: rgba(247, 243, 233, 0.95);
            backdrop-filter: blur(15px);
            border-top: 1px solid rgba(168, 192, 154, 0.3);
        }
        
        .exercise-card {
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
        }
        
        .exercise-card:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.9);
        }
        
        .exercise-card.selected {
            background: rgba(168, 192, 154, 0.2);
            border-color: var(--sage-green);
        }
        
        .timer-display {
            font-size: 3rem;
            font-weight: 300;
            color: var(--deep-sage);
        }
        
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .progress-ring-circle {
            stroke: var(--sage-green);
            stroke-width: 4;
            fill: transparent;
            stroke-dasharray: 628;
            stroke-dashoffset: 628;
            transition: stroke-dashoffset 1s linear;
        }
        
        .water-ripple {
            position: absolute;
            border: 2px solid var(--pale-blue);
            border-radius: 50%;
            opacity: 0;
            animation: ripple 2s infinite;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }
            100% {
                transform: scale(1.4);
                opacity: 0;
            }
        }
        
        .sound-active {
            background: rgba(168, 192, 154, 0.2) !important;
            border-color: var(--sage-green) !important;
        }
        
        .sound-playing {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body class="text-gray-800 pb-20">
    <!-- Header -->
    <div class="px-6 pt-8 pb-4">
        <div class="flex items-center justify-between">
            <button onclick="navigateTo('index.html')" class="p-2 rounded-full bg-white/50 backdrop-blur-sm">
                <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <h1 class="font-display text-2xl text-gray-700">Time Out</h1>
            <div class="w-10"></div>
        </div>
    </div>
    
    <!-- Breathing Exercise Section -->
    <div class="px-6 mb-8">
        <div class="glass-card rounded-2xl p-6">
            <h2 class="font-display text-xl text-center mb-6 text-gray-700">Choose Your Breath</h2>
            
            <!-- Exercise Selection -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="exercise-card rounded-xl p-4 text-center cursor-pointer border-2 border-transparent" 
                     data-exercise="478" data-name="4-7-8 Breathing">
                    <div class="text-2xl mb-2">üå¨Ô∏è</div>
                    <h3 class="font-medium text-sm text-gray-700">4-7-8 Breath</h3>
                    <p class="text-xs text-gray-500 mt-1">For anxiety & sleep</p>
                </div>
                
                <div class="exercise-card rounded-xl p-4 text-center cursor-pointer border-2 border-transparent" 
                     data-exercise="box" data-name="Box Breathing">
                    <div class="text-2xl mb-2">‚¨ú</div>
                    <h3 class="font-medium text-sm text-gray-700">Box Breathing</h3>
                    <p class="text-xs text-gray-500 mt-1">For focus & calm</p>
                </div>
                
                <div class="exercise-card rounded-xl p-4 text-center cursor-pointer border-2 border-transparent" 
                     data-exercise="calm" data-name="Calm Breath">
                    <div class="text-2xl mb-2">üïäÔ∏è</div>
                    <h3 class="font-medium text-sm text-gray-700">Calm Breath</h3>
                    <p class="text-xs text-gray-500 mt-1">For daily peace</p>
                </div>
                
                <div class="exercise-card rounded-xl p-4 text-center cursor-pointer border-2 border-transparent" 
                     data-exercise="energy" data-name="Energizing Breath">
                    <div class="text-2xl mb-2">‚ö°</div>
                    <h3 class="font-medium text-sm text-gray-700">Energy Breath</h3>
                    <p class="text-xs text-gray-500 mt-1">For vitality</p>
                </div>
            </div>
            
            <!-- Duration Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-600 mb-3">Duration</label>
                <div class="flex space-x-2">
                    <button class="duration-btn px-4 py-2 rounded-lg border border-gray-200 text-sm" data-duration="60">1 min</button>
                    <button class="duration-btn px-4 py-2 rounded-lg border border-gray-200 text-sm" data-duration="180">3 min</button>
                    <button class="duration-btn px-4 py-2 rounded-lg border border-gray-200 text-sm" data-duration="300">5 min</button>
                    <button class="duration-btn px-4 py-2 rounded-lg border border-gray-200 text-sm" data-duration="600">10 min</button>
                </div>
            </div>
            
            <!-- Start Button -->
            <button id="startBreathing" class="w-full py-4 rounded-xl font-medium text-white transition-all duration-300 opacity-50 cursor-not-allowed" 
                    style="background: var(--sage-green);" disabled>
                Start Your Practice
            </button>
        </div>
    </div>
    
    <!-- Breathing Session -->
    <div id="breathingSession" class="hidden px-6 mb-8">
        <div class="glass-card rounded-2xl p-8 text-center">
            <!-- Progress Ring -->
            <div class="relative w-64 h-64 mx-auto mb-6">
                <svg class="progress-ring w-full h-full absolute inset-0">
                    <circle class="progress-ring-circle" cx="128" cy="128" r="100"></circle>
                </svg>
                
                <!-- Breathing Circle -->
                <div id="breathingCircle" class="breathing-circle absolute inset-0 m-8"></div>
                
                <!-- Timer Display -->
                <div class="absolute inset-0 flex items-center justify-center">
                    <div id="timerDisplay" class="timer-display">5:00</div>
                </div>
            </div>
            
            <!-- Breathing Instruction -->
            <div id="breathingInstruction" class="mb-6">
                <h3 class="font-display text-xl text-gray-700 mb-2">Get Ready</h3>
                <p class="text-gray-600">Find a comfortable position</p>
            </div>
            
            <!-- Session Controls -->
            <div class="flex justify-center space-x-4">
                <button id="pauseBtn" class="px-6 py-3 rounded-xl border border-gray-300 text-gray-600">
                    Pause
                </button>
                <button id="stopBtn" class="px-6 py-3 rounded-xl text-white" style="background: var(--dusty-rose);">
                    Stop
                </button>
            </div>
        </div>
    </div>
    
    <!-- Sound Environment -->
    <div class="px-6 mb-8">
        <div class="glass-card rounded-2xl p-6">
            <h2 class="font-display text-xl text-center mb-6 text-gray-700">Sound Environment</h2>
            
            <!-- Sound Options -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="sound-card rounded-xl p-4 text-center cursor-pointer border-2 border-transparent" 
                     data-sound="ocean" data-audio="ocean-waves">
                    <div class="text-2xl mb-2">üåä</div>
                    <h3 class="font-medium text-sm text-gray-700">Ocean Waves</h3>
                    <div class="sound-waves hidden mt-2 flex justify-center space-x-1">
                        <div class="sound-wave" style="animation-delay: 0s;"></div>
                        <div class="sound-wave" style="animation-delay: 0.1s;"></div>
                        <div class="sound-wave" style="animation-delay: 0.2s;"></div>
                        <div class="sound-wave" style="animation-delay: 0.3s;"></div>
                    </div>
                </div>
                
                <div class="sound-card rounded-xl p-4 text-center cursor-pointer border-2 border-transparent" 
                     data-sound="forest" data-audio="forest-sounds">
                    <div class="text-2xl mb-2">üå≤</div>
                    <h3 class="font-medium text-sm text-gray-700">Forest Sounds</h3>
                    <div class="sound-waves hidden mt-2 flex justify-center space-x-1">
                        <div class="sound-wave" style="animation-delay: 0s;"></div>
                        <div class="sound-wave" style="animation-delay: 0.2s;"></div>
                        <div class="sound-wave" style="animation-delay: 0.1s;"></div>
                        <div class="sound-wave" style="animation-delay: 0.3s;"></div>
                    </div>
                </div>
                
                <div class="sound-card rounded-xl p-4 text-center cursor-pointer border-2 border-transparent" 
                     data-sound="rain" data-audio="gentle-rain">
                    <div class="text-2xl mb-2">üåßÔ∏è</div>
                    <h3 class="font-medium text-sm text-gray-700">Gentle Rain</h3>
                    <div class="sound-waves hidden mt-2 flex justify-center space-x-1">
                        <div class="sound-wave" style="animation-delay: 0.1s;"></div>
                        <div class="sound-wave" style="animation-delay: 0.3s;"></div>
                        <div class="sound-wave" style="animation-delay: 0s;"></div>
                        <div class="sound-wave" style="animation-delay: 0.2s;"></div>
                    </div>
                </div>
                
                <div class="sound-card rounded-xl p-4 text-center cursor-pointer border-2 border-transparent" 
                     data-sound="silence" data-audio="silence">
                    <div class="text-2xl mb-2">ü§´</div>
                    <h3 class="font-medium text-sm text-gray-700">Silence</h3>
                    <div class="sound-waves hidden mt-2 flex justify-center space-x-1">
                        <div class="sound-wave" style="height: 2px; animation: none;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Volume Control -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-600 mb-2">Volume</label>
                <input type="range" id="volumeSlider" min="0" max="100" value="50" 
                       class="w-full h-2 rounded-lg appearance-none" 
                       style="background: linear-gradient(to right, var(--sage-green) 50%, var(--warm-gray) 50%);">
            </div>
        </div>
    </div>
    
    <!-- Quick Calm -->
    <div class="px-6 mb-8">
        <div class="glass-card rounded-2xl p-6 text-center">
            <h2 class="font-display text-xl mb-4 text-gray-700">Need Immediate Calm?</h2>
            <p class="text-sm text-gray-600 mb-4">Try our 2-minute emergency calm session</p>
            <button id="quickCalm" class="px-8 py-3 rounded-xl font-medium text-white" 
                    style="background: var(--muted-coral);">
                Quick Calm (2 min)
            </button>
        </div>
    </div>
    
    <!-- Progress Tracking -->
    <div class="px-6 mb-8">
        <div class="glass-card rounded-2xl p-6">
            <h2 class="font-display text-xl text-center mb-6 text-gray-700">Your Progress</h2>
            
            <!-- Today's Stats -->
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="text-center">
                    <div class="text-2xl font-bold text-gray-700 mb-1" id="todaySessions">0</div>
                    <div class="text-xs text-gray-500">Sessions Today</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-gray-700 mb-1" id="todayMinutes">0</div>
                    <div class="text-xs text-gray-500">Minutes Today</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-gray-700 mb-1" id="streakDays">1</div>
                    <div class="text-xs text-gray-500">Day Streak</div>
                </div>
            </div>
            
            <!-- Recent Sessions -->
            <div class="mt-6">
                <h3 class="font-medium text-gray-700 mb-3">Recent Sessions</h3>
                <div id="recentSessions" class="space-y-2">
                    <div class="flex justify-between items-center py-2 px-3 rounded-lg bg-white/50">
                        <span class="text-sm text-gray-600">4-7-8 Breathing</span>
                        <span class="text-xs text-gray-500">5 min ago</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <nav class="nav-bottom fixed bottom-0 left-0 right-0 px-6 py-4 z-20">
        <div class="flex justify-around items-center max-w-md mx-auto">
            <button onclick="navigateTo('index.html')" class="flex flex-col items-center space-y-1">
                <div class="w-6 h-6 rounded-full opacity-30" style="background: var(--sage-green);"></div>
                <span class="text-xs text-gray-400">Home</span>
            </button>
            <button onclick="navigateTo('timeout.html')" class="flex flex-col items-center space-y-1">
                <div class="w-6 h-6 rounded-full" style="background: var(--dusty-rose);"></div>
                <span class="text-xs text-gray-600">Time Out</span>
            </button>
            <button onclick="navigateTo('decenter.html')" class="flex flex-col items-center space-y-1">
                <div class="w-6 h-6 rounded-full opacity-30" style="background: var(--muted-coral);"></div>
                <span class="text-xs text-gray-400">Decenter</span>
            </button>
            <button onclick="navigateTo('glow.html')" class="flex flex-col items-center space-y-1">
                <div class="w-6 h-6 rounded-full opacity-30" style="background: var(--pale-blue);"></div>
                <span class="text-xs text-gray-400">Glow</span>
            </button>
            <button onclick="navigateTo('support.html')" class="flex flex-col items-center space-y-1">
                <div class="w-6 h-6 rounded-full opacity-30" style="background: var(--golden-honey);"></div>
                <span class="text-xs text-gray-400">Support</span>
            </button>
        </div>
    </nav>
    
    <script>
        // Global variables
        let selectedExercise = null;
        let selectedDuration = 300; // 5 minutes default
        let selectedSound = 'ocean';
        let breathingTimer = null;
        let sessionActive = false;
        let currentAudio = null;
        let sessionData = {
            exercises: {
                '478': { inhale: 4, hold: 7, exhale: 8, name: '4-7-8 Breathing' },
                'box': { inhale: 4, hold: 4, exhale: 4, hold2: 4, name: 'Box Breathing' },
                'calm': { inhale: 4, hold: 2, exhale: 6, name: 'Calm Breath' },
                'energy': { inhale: 2, exhale: 2, name: 'Energizing Breath' }
            },
            progress: JSON.parse(localStorage.getItem('calmishProgress')) || {
                todaySessions: 0,
                todayMinutes: 0,
                streakDays: 1,
                recentSessions: []
            }
        };
        
        // Audio context for sound generation
        let audioContext = null;
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateProgressDisplay();
            initializeAudio();
            
            // Auto-select first exercise and duration
            document.querySelector('.exercise-card').click();
            document.querySelector('.duration-btn').click();
            document.querySelector('.sound-card').click();
        });
        
        function initializeAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.log('Web Audio API not supported');
            }
        }
        
        function setupEventListeners() {
            // Exercise selection
            document.querySelectorAll('.exercise-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('.exercise-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedExercise = this.dataset.exercise;
                    checkStartButton();
                });
            });
            
            // Duration selection
            document.querySelectorAll('.duration-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.duration-btn').forEach(b => {
                        b.classList.remove('bg-sage-green', 'text-white');
                        b.classList.add('border-gray-200');
                    });
                    this.classList.add('bg-sage-green', 'text-white');
                    this.classList.remove('border-gray-200');
                    selectedDuration = parseInt(this.dataset.duration);
                    checkStartButton();
                });
            });
            
            // Sound selection
            document.querySelectorAll('.sound-card').forEach(card => {
                card.addEventListener('click', function() {
                    // Stop current sound
                    stopSound();
                    
                    // Remove active state from all sound cards
                    document.querySelectorAll('.sound-card').forEach(c => {
                        c.classList.remove('sound-active');
                        c.querySelector('.sound-waves').classList.add('hidden');
                    });
                    
                    // Add active state to clicked card
                    this.classList.add('sound-active');
                    selectedSound = this.dataset.sound;
                    
                    // Show sound waves
                    this.querySelector('.sound-waves').classList.remove('hidden');
                    
                    // Start playing the sound
                    playSound(this.dataset.audio);
                });
            });
            
            // Volume control
            document.getElementById('volumeSlider').addEventListener('input', function(e) {
                const value = e.target.value;
                const percentage = (value / 100) * 100;
                e.target.style.background = `linear-gradient(to right, var(--sage-green) ${percentage}%, var(--warm-gray) ${percentage}%)`;
                
                // Update volume if audio is playing
                if (currentAudio) {
                    currentAudio.volume = value / 100;
                }
            });
            
            // Start breathing button
            document.getElementById('startBreathing').addEventListener('click', startBreathingSession);
            
            // Session controls
            document.getElementById('pauseBtn').addEventListener('click', pauseSession);
            document.getElementById('stopBtn').addEventListener('click', stopSession);
            
            // Quick calm button
            document.getElementById('quickCalm').addEventListener('click', startQuickCalm);
        }
        
        function checkStartButton() {
            const startBtn = document.getElementById('startBreathing');
            if (selectedExercise && selectedDuration) {
                startBtn.disabled = false;
                startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                startBtn.classList.add('hover:opacity-90');
            }
        }
        
        function playSound(soundType) {
            if (!audioContext) return;
            
            // Create different soundscapes using Web Audio API
            try {
                switch(soundType) {
                    case 'ocean-waves':
                        playOceanWaves();
                        break;
                    case 'forest-sounds':
                        playForestSounds();
                        break;
                    case 'gentle-rain':
                        playRainSounds();
                        break;
                    case 'silence':
                        stopSound();
                        break;
                }
            } catch (e) {
                console.log('Error playing sound:', e);
            }
        }
        
        function playOceanWaves() {
            // Create a simple ocean wave sound using white noise and filtering
            const bufferSize = audioContext.sampleRate * 2;
            const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const data = buffer.getChannelData(0);
            
            // Generate white noise
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }
            
            const whiteNoise = audioContext.createBufferSource();
            whiteNoise.buffer = buffer;
            whiteNoise.loop = true;
            
            // Create filter for ocean wave effect
            const filter = audioContext.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 400;
            filter.Q.value = 1;
            
            // Create gain node for volume control
            const gainNode = audioContext.createGain();
            gainNode.gain.value = 0.3;
            
            // Connect nodes
            whiteNoise.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            whiteNoise.start();
            currentAudio = { source: whiteNoise, gain: gainNode, type: 'ocean' };
        }
        
        function playForestSounds() {
            // Create a simple forest ambiance
            const bufferSize = audioContext.sampleRate * 3;
            const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const data = buffer.getChannelData(0);
            
            // Generate brown noise for forest base
            let lastOut = 0.0;
            for (let i = 0; i < bufferSize; i++) {
                const white = Math.random() * 2 - 1;
                data[i] = (lastOut + (0.02 * white)) / 1.02;
                lastOut = data[i];
                data[i] *= 3.5;
            }
            
            const brownNoise = audioContext.createBufferSource();
            brownNoise.buffer = buffer;
            brownNoise.loop = true;
            
            // Create filter
            const filter = audioContext.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 800;
            
            const gainNode = audioContext.createGain();
            gainNode.gain.value = 0.2;
            
            brownNoise.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            brownNoise.start();
            currentAudio = { source: brownNoise, gain: gainNode, type: 'forest' };
        }
        
        function playRainSounds() {
            // Create rain sound using filtered white noise
            const bufferSize = audioContext.sampleRate * 2;
            const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const data = buffer.getChannelData(0);
            
            // Generate white noise
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }
            
            const whiteNoise = audioContext.createBufferSource();
            whiteNoise.buffer = buffer;
            whiteNoise.loop = true;
            
            // Create filter for rain effect
            const filter = audioContext.createBiquadFilter();
            filter.type = 'bandpass';
            filter.frequency.value = 1000;
            filter.Q.value = 0.5;
            
            const gainNode = audioContext.createGain();
            gainNode.gain.value = 0.25;
            
            whiteNoise.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            whiteNoise.start();
            currentAudio = { source: whiteNoise, gain: gainNode, type: 'rain' };
        }
        
        function stopSound() {
            if (currentAudio && currentAudio.source) {
                try {
                    currentAudio.source.stop();
                } catch (e) {
                    // Source might already be stopped
                }
                currentAudio = null;
            }
        }
        
        function startBreathingSession() {
            if (!selectedExercise) return;
            
            // Hide selection, show session
            document.querySelector('.glass-card').style.display = 'none';
            document.getElementById('breathingSession').classList.remove('hidden');
            
            // Setup session
            const exercise = sessionData.exercises[selectedExercise];
            sessionActive = true;
            
            // Start breathing animation
            startBreathingAnimation(exercise);
            
            // Start timer
            startTimer(selectedDuration);
            
            // Add to recent sessions
            addRecentSession(exercise.name, selectedDuration);
        }
        
        function startBreathingAnimation(exercise) {
            const circle = document.getElementById('breathingCircle');
            const instruction = document.getElementById('breathingInstruction');
            
            let phase = 'inhale';
            let count = 0;
            
            function updateBreathing() {
                if (!sessionActive) return;
                
                switch(phase) {
                    case 'inhale':
                        instruction.innerHTML = '<h3 class="font-display text-xl text-gray-700 mb-2">Breathe In</h3><p class="text-gray-600">Slowly through your nose</p>';
                        circle.className = 'breathing-circle inhale';
                        setTimeout(() => {
                            phase = exercise.hold ? 'hold' : 'exhale';
                            updateBreathing();
                        }, exercise.inhale * 1000);
                        break;
                        
                    case 'hold':
                        instruction.innerHTML = '<h3 class="font-display text-xl text-gray-700 mb-2">Hold</h3><p class="text-gray-600">Gently pause</p>';
                        circle.className = 'breathing-circle hold';
                        setTimeout(() => {
                            phase = 'exhale';
                            updateBreathing();
                        }, exercise.hold * 1000);
                        break;
                        
                    case 'exhale':
                        instruction.innerHTML = '<h3 class="font-display text-xl text-gray-700 mb-2">Breathe Out</h3><p class="text-gray-600">Slowly through your mouth</p>';
                        circle.className = 'breathing-circle exhale';
                        setTimeout(() => {
                            phase = 'inhale';
                            updateBreathing();
                        }, exercise.exhale * 1000);
                        break;
                }
            }
            
            updateBreathing();
        }
        
        function startTimer(duration) {
            let timeLeft = duration;
            const timerDisplay = document.getElementById('timerDisplay');
            const progressCircle = document.querySelector('.progress-ring-circle');
            const circumference = 2 * Math.PI * 100;
            
            breathingTimer = setInterval(() => {
                if (!sessionActive) return;
                
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                // Update progress ring
                const progress = (duration - timeLeft) / duration;
                const offset = circumference - (progress * circumference);
                progressCircle.style.strokeDashoffset = offset;
                
                timeLeft--;
                
                if (timeLeft < 0) {
                    completeSession();
                }
            }, 1000);
        }
        
        function pauseSession() {
            sessionActive = !sessionActive;
            const pauseBtn = document.getElementById('pauseBtn');
            pauseBtn.textContent = sessionActive ? 'Pause' : 'Resume';
        }
        
        function stopSession() {
            sessionActive = false;
            if (breathingTimer) {
                clearInterval(breathingTimer);
                breathingTimer = null;
            }
            
            // Stop sound
            stopSound();
            
            // Show completion message
            showCompletionMessage();
            
            // Return to selection
            setTimeout(() => {
                document.getElementById('breathingSession').classList.add('hidden');
                document.querySelector('.glass-card').style.display = 'block';
                resetSession();
            }, 3000);
        }
        
        function completeSession() {
            sessionActive = false;
            clearInterval(breathingTimer);
            
            // Update progress
            sessionData.progress.todaySessions++;
            sessionData.progress.todayMinutes += Math.floor(selectedDuration / 60);
            saveProgress();
            updateProgressDisplay();
            
            showCompletionMessage();
            
            setTimeout(() => {
                document.getElementById('breathingSession').classList.add('hidden');
                document.querySelector('.glass-card').style.display = 'block';
                resetSession();
            }, 3000);
        }
        
        function showCompletionMessage() {
            const instruction = document.getElementById('breathingInstruction');
            instruction.innerHTML = `
                <h3 class="font-display text-xl text-gray-700 mb-2">Well Done! üéâ</h3>
                <p class="text-gray-600">You've completed your breathing practice</p>
            `;
            
            // Animate completion
            anime({
                targets: '#breathingCircle',
                scale: [1, 1.1, 1],
                duration: 1000,
                easing: 'easeInOutSine'
            });
        }
        
        function resetSession() {
            const progressCircle = document.querySelector('.progress-ring-circle');
            progressCircle.style.strokeDashoffset = 628;
            document.getElementById('timerDisplay').textContent = '5:00';
            document.getElementById('breathingCircle').className = 'breathing-circle';
        }
        
        function startQuickCalm() {
            selectedExercise = '478';
            selectedDuration = 120; // 2 minutes
            document.querySelector('.exercise-card[data-exercise="478"]').click();
            document.querySelector('.duration-btn[data-duration="120"]').click();
            startBreathingSession();
        }
        
        function addRecentSession(exerciseName, duration) {
            const recentSession = {
                exercise: exerciseName,
                duration: duration,
                timestamp: new Date().toISOString()
            };
            
            sessionData.progress.recentSessions.unshift(recentSession);
            if (sessionData.progress.recentSessions.length > 5) {
                sessionData.progress.recentSessions.pop();
            }
            
            saveProgress();
        }
        
        function updateProgressDisplay() {
            document.getElementById('todaySessions').textContent = sessionData.progress.todaySessions;
            document.getElementById('todayMinutes').textContent = sessionData.progress.todayMinutes;
            document.getElementById('streakDays').textContent = sessionData.progress.streakDays;
            
            // Update recent sessions
            const recentContainer = document.getElementById('recentSessions');
            recentContainer.innerHTML = '';
            
            sessionData.progress.recentSessions.forEach(session => {
                const timeAgo = getTimeAgo(new Date(session.timestamp));
                const sessionDiv = document.createElement('div');
                sessionDiv.className = 'flex justify-between items-center py-2 px-3 rounded-lg bg-white/50';
                sessionDiv.innerHTML = `
                    <span class="text-sm text-gray-600">${session.exercise}</span>
                    <span class="text-xs text-gray-500">${timeAgo}</span>
                `;
                recentContainer.appendChild(sessionDiv);
            });
        }
        
        function saveProgress() {
            localStorage.setItem('calmishProgress', JSON.stringify(sessionData.progress));
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min ago`;
            if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
            return `${Math.floor(diffMins / 1440)}d ago`;
        }
        
        function navigateTo(page) {
            // Stop any playing audio before navigating
            stopSound();
            
            anime({
                targets: 'body',
                opacity: [1, 0.8],
                duration: 200,
                easing: 'easeOutQuart',
                complete: function() {
                    window.location.href = page;
                }
            });
        }
        
        // Handle page visibility change to pause sounds
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && currentAudio) {
                stopSound();
            }
        });
    </script>
</body>
</html>